# 训练数据和测试文件路径, 支持多个文件，匹配规则参考glob
train_input_path: "train"
eval_input_path: "eval"
# 模型保存路径
model_dir: "custom_model"



# 数据相关的描述
data_config {
  input_fields {
    input_name:'ip_cnt'
    input_type: INT64
    default_val: '0'

  }
  input_fields {
    input_name:'osv_cnt'
    input_type: INT64
    default_val: '0'
  }
  input_fields {
    input_name:'make_cnt'
    input_type: INT64
    default_val: '0'

  }
  input_fields {
    input_name:'model_cnt'
    input_type: INT64
    default_val: '0'
  }
  input_fields {
    input_name:'geo_city_cnt'
    input_type: INT64
    default_val: '0'
  }
  input_fields {
    input_name:'active_days_cnt'
    input_type: INT64
    default_val: '0'
  }
  input_fields {
    input_name:'osv_list_end'
    input_type: STRING
    default_val: 'P'
    input_dim: 20
  }
  input_fields {
    input_name:'make_list_end'
    input_type: STRING
    default_val: 'P'
    input_dim: 20
  }
  input_fields {
    input_name:'model_list_end'
    input_type: STRING
    default_val: 'P'
    input_dim: 20
  }
  input_fields {
    input_name:'geo_city_list_end'
    input_type: STRING
    default_val: 'P'
    input_dim: 20
  }

  input_fields {
    input_name:'devicetype_list_end'
    input_type: STRING
    default_val: 'P'
    input_dim: 20
  }
  input_fields {
    input_name:'connectiontype_list_end'
    input_type: STRING
    default_val: 'P'
    input_dim: 20
  }
  input_fields {
    input_name:'bundle_list_all_end'
    input_type: STRING
    default_val: 'P'
    input_dim: 100
  }
  input_fields {
    input_name:'bundle_adx_list_all_end'
    input_type: STRING
    default_val: 'P'
    input_dim: 200
  }
  input_fields {
    input_name:'osv_list_all_end'
    input_type: STRING
    default_val: 'P'
    input_dim: 100
  }
  input_fields {
    input_name:'make_list_all_end'
    input_type: STRING
    default_val: 'P'
    input_dim: 100
  }
  input_fields {
    input_name:'model_list_all_end'
    input_type: STRING
    default_val: 'P'
    input_dim: 100
  }
  input_fields {
    input_name:'geo_city_list_all_end'
    input_type: STRING
    default_val: 'P'
    input_dim: 100
  }
  input_fields {
    input_name:'media_id_list_end'
    input_type: STRING
    default_val: 'P'
    input_dim: 20
  }
  input_fields {
    input_name:'dmp_event_list_end'
    input_type: STRING
    default_val: 'P'
    input_dim: 20
  }
  input_fields {
    input_name:'bundle_list_[0-14]_end'
    input_type: STRING
    default_val: 'P'
    input_dim: 20
  }
  input_fields {
    input_name:'bundle_adx_list_[0-14]_end'
    input_type: STRING
    default_val: 'P'
    input_dim: 20
  }

  input_fields {
    input_name:'label'
    input_type: INT64
    default_val: '0'
  }

  auto_expand_input_fields: true

  label_fields: "label"

  batch_size: 0
  num_epochs: 0
  prefetch_size: 64

  num_parallel_calls:20

  input_type: TFRecordInput
  data_compression_type: "GZIP"


}

# 特征相关
feature_config : {
  features: {
    input_names: "ip_cnt"
    shared_names: ["osv_cnt","make_cnt","model_cnt","geo_city_cnt","active_days_cnt"]
    feature_type: RawFeature
    boundaries: [1, 2, 4, 7, 10, 15, 20, 30, 40, 50, 60, 70, 80, 90]
    embedding_dim: 3
  }
  features: {
    input_names: "osv_list_end"
    shared_names: "osv_list_all_end"
    feature_type: SequenceFeature
    sub_feature_type: IdFeature
    vocab_list: "info/osv_info"
    embedding_dim: 3
    embedding_name:"osv"
    combiner:"sqrtn"
  }
  features: {
    input_names: "make_list_end"
    shared_names: "make_list_all_end"
    feature_type: SequenceFeature
    sub_feature_type: IdFeature
    vocab_list: "info/make_info"
    embedding_dim: 3
    embedding_name:"make"
    combiner:"sqrtn"
  }
  features: {
    input_names: "model_list_end"
    shared_names: "model_list_all_end"
    feature_type: SequenceFeature
    sub_feature_type: IdFeature
    vocab_list: "info/model_info"
    embedding_dim: 3
    embedding_name:"model"
    combiner:"sqrtn"
  }
  features: {
    input_names: "geo_city_list_end"
    shared_names: "geo_city_list_all_end"
    feature_type: SequenceFeature
    sub_feature_type: IdFeature
    vocab_list: "info/geo_city_info"
    embedding_dim: 3
    embedding_name:"geo_city"
    combiner:"sqrtn"
  }
  features: {
    input_names: "devicetype_list_end"
    feature_type: SequenceFeature
    sub_feature_type: IdFeature
    vocab_list: "info/devicetype_info"
    embedding_dim: 3
    embedding_name:"devicetype"
    combiner:"sqrtn"
  }
  features: {
    input_names: "connectiontype_list_end"
    feature_type: SequenceFeature
    sub_feature_type: IdFeature
    vocab_list: "info/connectiontype_info"
    embedding_dim: 3
    embedding_name:"connectiontype"
    combiner:"sqrtn"
  }
  features: {
    input_names: "bundle_list_all_end"
    shared_names: "bundle_list_[0-14]_end"
    feature_type: SequenceFeature
    sub_feature_type: IdFeature
    vocab_list: "info/bundle_info"
    embedding_dim: 12
    embedding_name:"bundle"
    combiner:"sqrtn"
  }
  features: {
    input_names: "bundle_adx_list_all_end"
    shared_names: "bundle_adx_list_[0-14]_end"
    feature_type: SequenceFeature
    sub_feature_type: IdFeature
    vocab_list: "info/bundle_adx_info"
    embedding_dim: 12
    embedding_name:"bundle_adx"
    combiner:"sqrtn"
  }
  features: {
    input_names: "media_id_list_end"
    feature_type: SequenceFeature
    sub_feature_type: IdFeature
    vocab_list: "info/media_id_info"
    embedding_dim: 3
    embedding_name:"media_id"
    combiner:"sqrtn"
  }
  features: {
    input_names: "dmp_event_list_end"
    feature_type: SequenceFeature
    sub_feature_type: IdFeature
    vocab_list: "info/dmp_event_info"
    embedding_dim: 3
    embedding_name:"dmp_event"
    combiner:"sqrtn"
  }
}

# 训练相关的参数
train_config {
  log_step_count_steps: 3
  save_checkpoints_steps: 0
  # fine_tune_checkpoint: ""
  optimizer_config: {
    adam_optimizer: {
      learning_rate: {
        exponential_decay_learning_rate {
          initial_learning_rate: 0.1
          decay_steps: 10000
          decay_factor: 0.5
          min_learning_rate: 0.0000001
        }
      }
    }
    use_moving_average: false
  }
}

# 评估相关
eval_config {
  eval_online:True
  metrics_set: {
       auc {
            num_thresholds:10000
       }
  }
}

# 模型相关
model_config: {
  model_class: 'CustomModel'
  feature_groups: {
    group_name: "raw_feature"
    feature_names: "ip_cnt"
    feature_names: "osv_cnt"
    feature_names: "make_cnt"
    feature_names: "model_cnt"
    feature_names: "geo_city_cnt"
    feature_names: "active_days_cnt"
    wide_deep:DEEP
  }
  feature_groups: {
    group_name: "seq_feature"
    feature_names: "bundle_list_all_end"
    feature_names: "bundle_adx_list_all_end"
    feature_names: "osv_list_all_end"
    feature_names: "make_list_all_end"
    feature_names: "model_list_all_end"
    feature_names: "geo_city_list_all_end"
    feature_names: "osv_list_end"
    feature_names: "make_list_end"
    feature_names: "model_list_end"
    feature_names: "geo_city_list_end"
    feature_names: "devicetype_list_end"
    feature_names: "connectiontype_list_end"
    feature_names: "media_id_list_end"
    feature_names: "dmp_event_list_end"
    wide_deep:DEEP
  }
  feature_groups: {
    group_name: "multi_head_feature_1"
    feature_names: "bundle_list_[0-14]_end"
    wide_deep:DEEP
  }
  feature_groups: {
    group_name: "multi_head_feature_2"
    feature_names: "bundle_adx_list_[0-14]_end"
    wide_deep:DEEP
  }

  custom_model {
    # specify the params defined in easy_rec/python/protos/custom_model.proto
  }

  model_params {
    l2_regularization: 1e-6
  }
  embedding_regularization: 1e-5
}
